# 项目级配置设计（汇总方案）

## 背景

当前 `wt` 在全局配置 `~/.worktree.sh/config.kv` 中同时承担“模板默认值”和“项目状态”两种职责，导致：

- 不同仓库之间切换时需要手动改动全局文件或重复 `wt init`。
- `wt main`、`wt list` 等命令虽然可在任意目录跳转，但全局状态往往被最后一次使用的仓库覆盖。
- 多项目并行时难以区分各自的 worktree 与配置。

目标是保留“任意目录使用 wt 命令”的体验，同时将项目状态与全局默认值解耦，让多项目场景下的行为更清晰。

## 设计目标

- 引入项目级配置文件，实现“默认 → 全局模板 → 项目配置”的叠加读取。
- 单项目用户保持现有体验，多项目用户获得跨项目选择能力。
- 不新增 CLI 子命令；改动尽量透明，兼容既有脚本调用。
- `WT_CONFIG_FILE` 继续拥有最高优先级；配置写入仅在识别出项目时执行。

## 功能原则与用户体验

- **无任何项目配置（0 个）**：所有需要项目上下文的命令直接提示“请在目标仓库运行 wt init”；仅保留 `wt help`、`wt init` 等纯全局命令可用。
- **恰好 1 个项目**：尽量沿用旧体验——`wt main`、`wt list`、`wt clean`、`wt <worktree>` 等都直接落在该项目，无需额外选择。
- **≥ 2 个项目**：进入多项目模式。全局下调用需要路径的命令时列出候选项目/工作树，由用户逐次确认后执行；不在项目目录时不保留会话上下文。

命令行为摘要（P=需要项目、G=全局模式下可运行的逻辑）：

| 命令                               | 单项目                                                                 | 多项目（全局态）                                                               | 多项目（项目目录）                                                     |
| ---------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------------------------------------------ | ---------------------------------------------------------------------- |
| `wt` / `wt help`                   | 显示帮助                                                               | 显示帮助                                                                       | 显示帮助                                                               |
| `wt init`                          | 在当前仓库写项目文件                                                   | 在项目目录执行时与单项目一致；若在全局态调用则提示需在项目内执行               | 同左                                                                   |
| `wt main`                          | 直接输出主仓绝对路径（shell hook auto-cd）                             | 列出所有项目供选择，确认后输出所选项目主仓路径（auto-cd）                      | 输出当前项目主仓路径（auto-cd）                                        |
| `wt list`                          | 列出该项目 worktree                                                    | 跨项目分组列出全部 worktree                                                    | 列出当前项目                                                           |
| `wt <name>` / `wt path <name>`     | 打印该项目 worktree 路径（auto-cd）                                    | 全局搜索匹配，0 命中提示 init，1 命中直接打印，多命中列出选择再打印（auto-cd） | 直接打印当前项目的目标路径（auto-cd）                                  |
| `wt clean`                         | 清理当前项目数字 worktree；若删除当前目录，最终输出主仓路径（auto-cd） | 汇总候选并逐项确认后清理，按选择项目逐条输出处理结果                           | 同单项目                                                               |
| `wt rm`                            | 删除当前 worktree；若目标是当前目录，最终输出主仓路径（auto-cd）       | 提示需在项目内执行                                                             | 删除当前 worktree；若目标是当前目录，最终输出主仓路径（auto-cd）       |
| `wt rm <name>`                     | 删除该 worktree；若目标是当前目录，最终输出主仓路径（auto-cd）         | 全局搜索匹配逐项确认；若目标是当前目录，最终输出所选项目主仓路径（auto-cd）    | 删除当前项目同名 worktree；若目标是当前目录，仍输出主仓路径（auto-cd） |
| `wt add`                           | 创建新 worktree 并打印新目录路径（auto-cd）                            | 提示需在项目内执行                                                             | 创建新 worktree 并打印新目录路径（auto-cd）                            |
| `wt merge`                         | 正常执行                                                               | 提示需在项目内执行                                                             | 正常执行                                                               |
| `wt config set <k> <v>`            | 写当前项目                                                             | 提示需在项目内执行                                                             | 写当前项目                                                             |
| `wt config unset`                  | 从当前项目移除键                                                       | 提示需在项目内执行                                                             | 从当前项目移除键                                                       |
| 其他如 `wt uninstall`、`wt reinstall` | 全局可用                                                               | 全局可用                                                                       | 全局可用                                                               |

## 配置层次与写入规则

1. **默认值**：保留脚本内置常量，用于第一层。
2. **全局模板**：`~/.worktree.sh/config.kv` 可选，仅存放跨项目默认键（目前只需要 `language` 等少量模板项）。若无默认值需求，该文件可以不存在或为空；不会再写入 `repo.path` 等项目私有信息。
3. **项目配置**：`~/.worktree.sh/projects/<slug>/config.kv` 保存具体仓库与 worktree 状态。

读取时依次合并上述三层；写入遵循：

- `wt config set <key> <value>` 行为对齐 `git config` 的项目模式：默认作用于当前项目文件；若当前未识别项目，则提示用户进入项目后重试。
- `wt config unset` 遵循相同规则：仅在识别到项目时才执行，未识别时提示进入项目。

## 项目识别与 slug 生成

- 使用 `git rev-parse --git-common-dir --path-format=absolute` 获取共享 git 目录，取其父目录作为项目根。
- slug 基于仓库的绝对路径生成带前缀的连字符名称，例如：`-Users-notdp-Developer-worktree-sh`。规则：移除开头的 `/`，将路径分隔符、`.` 以及其他非法字符统一替换为 `-` 并压缩重复的连字符；若结果与既有项目冲突，则追加 `-<hash>` 后缀（使用仓库路径的哈希前缀）以保证唯一性。
- 项目目录结构：

  ```plain
  ~/.worktree.sh/
    config.kv              # 仅保留语言与少量元信息
    projects/
      -Users-notdp-Developer-worktree-sh/
        config.kv
      -Users-notdp-Developer-franxx-ai/
        config.kv
  ```

- 无需维护额外的 `projects/index`；枚举时直接遍历目录。

## 单项目体验

通过扫描 `projects/` 目录统计可用项目时，如仅检测到一个项目配置，命令与当前版本保持一致，无需额外选择流程。

## 多项目模式（≥ 2 个项目时启用）

### 全局态交互

- 在全局模式（当前目录未解析出项目）调用需要路径的命令时，实时枚举 `projects/<slug>/config.kv`，提取 `repo.path`、`repo.branch`、`WORKTREE_NAME_PREFIX` 等信息，为当次命令构建候选列表；执行完成后不保留会话上下文。

### 命令行为

- `wt main`：全局模式列出所有项目的主仓路径供选择，确认后输出所选项目的路径（auto-cd）。
- `wt list`：
  - 全局模式：按项目分组列出全部 worktree 及默认分支。
  - 在项目目录执行：保持单项目输出。
- `wt <worktree-name>` / `wt path <name>`：全局模式遍历所有项目的 worktree：
  - 0 命中：提示用户进入目标仓库运行 `wt init`。
  - 1 命中：直接打印匹配路径（auto-cd）。
  - 多命中：展示列表，由用户挑选后打印（auto-cd）。
- `wt clean`：
  - 全局模式：列出跨项目的数字 worktree，逐项确认后清理，并按项目输出处理结果，不触发 auto-cd。
  - 在项目目录执行：沿用单项目逻辑。
- `wt rm <name>`：全局模式下搜索全部项目的同名 worktree，逐项确认后删除；不带参数的 `wt rm` 继续要求在项目目录执行。
- `wt add`、`wt merge`、无参数 `wt rm`、`wt clean --current` 等修改性命令：全局模式提示“请进入项目或先运行 wt init”，不尝试自动跳转。

## 初始化与迁移

### `wt init` 幂等流程

- 通过 `git rev-parse --git-common-dir --path-format=absolute` 获取共享 git 目录，再取其父目录并使用 `realpath` 规范化，作为项目根；无论在主仓还是任意 worktree 执行 `wt init` 都会定位到同一项目。
- 基于规范化路径生成 slug（绝对路径 → 连字符形式；必要时追加短哈希），目标目录为 `~/.worktree.sh/projects/<slug>/`。
- 若目标目录不存在：
  - 创建目录并以 `config-example.kv` 为模板生成初始 `config.kv`，写入 `repo.path`、`repo.branch`、`WORKTREE_NAME_PREFIX` 等核心字段。
  - 如果创建或写入失败，清理新建目录并输出报错，确保用户可以重试。
- 若目标目录已存在：
  - 读取现有 `config.kv` 校验 `repo.path` 是否与当前项目根一致；一致则视为重复初始化，仅补全缺失字段并保持幂等。
  - 不一致时提示可能的 slug 碰撞或仓库迁移，拒绝覆盖并建议用户手动确认或使用修复命令。
- `wt init` 不维护项目计数；之后通过实时扫描 `projects/` 目录判断单/多项目场景。

### 遗留配置迁移与回滚

- 首次在新版本执行需项目状态的命令前，检测 `~/.worktree.sh/config.kv` 是否仍包含旧版项目字段（例如 `repo.path`、`worktrees.*`）。
- 若检测到遗留数据：
  1. 先生成时间戳备份 `config.kv.bak-<YYYYMMDD-HHMMSS>` 并向用户打印提示。
  2. 逐项解析旧条目，为每个项目生成 slug 与 `projects/<slug>/config.kv`，迁移完成后从模板文件移除对应字段，仅保留默认配置。
  3. 迁移中出现 IO/语法错误时，撤销新建项目文件并恢复备份，返回清晰错误信息。
- 为谨慎起见，提供显式的回滚指令或说明（例如 `mv ~/.worktree.sh/config.kv.bak-* ~/.worktree.sh/config.kv`），保证用户在迁移失败时可以恢复旧数据。
- 若用户拒绝迁移，CLI 继续读取旧版结构，但会提示升级无法完成，并要求在执行破坏性命令前完成迁移。

## Shell Hook 与补全

- `WT_CONFIG_FILE` 始终保留为用户/CI 显式指定配置文件时的最高优先级，CLI 不会写入或覆盖该变量。
- `wt shell-hook` 需要继续提供 auto-cd 能力；如需在 shell 侧增强体验，可通过函数包装解析命令输出，但不得篡改 `WT_CONFIG_FILE`。
- 自动补全逻辑可在项目目录内依赖 git 上下文，在全局态下按需枚举 `projects/<slug>`，提供候选名称而不记录会话状态。

## 错误与提示策略

- 当既无法解析项目，又在索引中找不到任何配置时，提示用户进入目标仓库并执行 `wt init`。
- 删除、清理等批量操作在全局模式下须显式列出即将影响的路径并要求确认。

## 待办与后续

- 更新 `bin/messages.sh`，为多项目选择与提示补充中英文文案。
- 更新 `README.md` / `README.zh-CN.md`，说明项目配置目录以及单/多项目场景下的命令行为。
- 调整 `wt shell-hook` 和自动补全脚本，在保持 auto-cd 的同时避免写入 `WT_CONFIG_FILE`，必要时通过函数包装解析命令输出。
- 编写手动验证脚本：
  1. 单项目场景下验证命令行为与旧版一致。
  2. 多项目场景下覆盖 `main/list/clean/rm` 等分支，确认全局模式选择流程。
  3. 验证 `WT_CONFIG_FILE` 覆盖能力并确认在未识别项目时 `wt config` 系列命令会提示进入项目。
